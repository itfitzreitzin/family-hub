<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Hub - Household Coordination System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .header h1 {
            font-size: 2em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-badges {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .status-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
        }
        
        .status-badge.active {
            background: #48bb78;
        }
        
        .tab-nav {
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .tab-nav-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            overflow-x: auto;
        }
        
        .tab-btn {
            padding: 15px 25px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 1em;
            color: #4a5568;
            transition: all 0.3s ease;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .tab-btn:hover {
            background: #f7fafc;
        }
        
        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: #f7fafc;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .card h2 {
            color: #2d3748;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .card h3 {
            color: #4a5568;
            margin-bottom: 15px;
        }
        
        /* Dashboard Specific */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .dashboard-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 20px;
            color: white;
        }
        
        .dashboard-card h3 {
            color: white;
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 10px;
        }
        
        .dashboard-card .value {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .dashboard-card .subtitle {
            font-size: 0.85em;
            opacity: 0.8;
        }
        
        .today-schedule {
            background: #f8fafc;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .schedule-timeline {
            position: relative;
            padding-left: 40px;
        }
        
        .timeline-item {
            position: relative;
            padding-bottom: 20px;
            border-left: 2px solid #e2e8f0;
            padding-left: 20px;
        }
        
        .timeline-item:last-child {
            border-left: none;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -7px;
            top: 5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: white;
            border: 2px solid #667eea;
        }
        
        .timeline-item.current::before {
            background: #48bb78;
            border-color: #48bb78;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        
        .timer-active {
            animation: pulse 2s ease-in-out infinite;
        }
        
        .timeline-time {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .timeline-content {
            color: #4a5568;
        }
        
        .timeline-who {
            display: inline-block;
            padding: 2px 8px;
            background: #edf2f7;
            border-radius: 12px;
            font-size: 0.85em;
            margin-left: 10px;
        }
        
        /* Schedule Coordinator */
        .calendar-container {
            overflow-x: auto;
            margin-bottom: 20px;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: 100px repeat(5, 1fr);
            gap: 10px;
            min-width: 700px;
        }
        
        .calendar-header {
            font-weight: bold;
            padding: 10px;
            background: #f7fafc;
            border-radius: 8px;
            text-align: center;
        }
        
        .calendar-label {
            font-weight: bold;
            padding: 10px;
            color: #4a5568;
        }
        
        .calendar-cell {
            padding: 10px;
            background: #f7fafc;
            border-radius: 8px;
            min-height: 60px;
            position: relative;
        }
        
        .calendar-cell.busy {
            background: #fed7d7;
            border: 1px solid #fc8181;
        }
        
        .calendar-cell.available {
            background: #c6f6d5;
            border: 1px solid #48bb78;
        }
        
        .calendar-cell.partial {
            background: #fef5e7;
            border: 1px solid #f6ad55;
        }
        
        .calendar-cell.nanny-suggested {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: bold;
        }
        
        .coverage-indicator {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 1.2em;
        }
        
        /* Nanny Tracker */
        .time-tracker {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: #48bb78;
            color: white;
        }
        
        .btn-danger {
            background: #f56565;
            color: white;
        }
        
        .btn-warning {
            background: #ed8936;
            color: white;
        }
        
        .btn-large {
            padding: 20px 40px;
            font-size: 1.2em;
        }
        
        /* Activity Tracker */
        .activity-list {
            list-style: none;
        }
        
        .activity-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .activity-item .activity-info {
            flex: 1;
        }
        
        .activity-item .activity-time {
            color: #667eea;
            font-weight: bold;
        }
        
        .activity-item .activity-name {
            font-size: 1.1em;
            color: #2d3748;
            margin: 5px 0;
        }
        
        .activity-item .activity-details {
            color: #718096;
            font-size: 0.9em;
        }
        
        .activity-status {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
        }
        
        .activity-status.upcoming {
            background: #e6f7ff;
            color: #1890ff;
        }
        
        .activity-status.ongoing {
            background: #d4f4dd;
            color: #52c41a;
        }
        
        .activity-status.completed {
            background: #f0f0f0;
            color: #8c8c8c;
        }
        
        /* Forms */
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            display: block;
            color: #4a5568;
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        
        .input-group input,
        .input-group select,
        .input-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
        }
        
        .input-group textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        /* Equity Tracker */
        .equity-bar {
            display: flex;
            height: 40px;
            border-radius: 20px;
            overflow: hidden;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .equity-segment {
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .equity-you {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .equity-partner {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .equity-legend {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 10px;
        }
        
        .equity-legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }
        
        /* AI Suggestions */
        .ai-suggestion {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid #f59e0b;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .ai-suggestion h3 {
            color: #92400e;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .ai-suggestion ul {
            margin-left: 20px;
            color: #78350f;
        }
        
        .ai-suggestion li {
            margin: 8px 0;
        }
        
        .suggestion-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }
        
        /* Notifications */
        .notification-settings {
            background: #f7fafc;
            border-radius: 10px;
            padding: 20px;
        }
        
        .notification-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .notification-option:last-child {
            border-bottom: none;
        }
        
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
            background: #cbd5e0;
            border-radius: 24px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .toggle-switch.active {
            background: #48bb78;
        }
        
        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.3s;
        }
        
        .toggle-switch.active::after {
            transform: translateX(26px);
        }
        
        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: #f7fafc;
            padding: 12px;
            text-align: left;
            color: #4a5568;
            font-weight: 600;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        tr:hover {
            background: #f7fafc;
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }
            
            .status-badges {
                margin-top: 15px;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .calendar-grid {
                grid-template-columns: 80px repeat(5, 1fr);
            }
            
            .tab-nav-content {
                justify-content: flex-start;
            }
        }
        
        /* Loading State */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0,0,0,.1);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Quick Actions */
        .quick-actions {
            position: fixed;
            bottom: 30px;
            right: 30px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .fab {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: all 0.3s ease;
        }
        
        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        .fab.mini {
            width: 40px;
            height: 40px;
            font-size: 18px;
        }
        
        /* Alerts */
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .alert-info {
            background: #e6f7ff;
            border: 1px solid #91d5ff;
            color: #0050b3;
        }
        
        .alert-success {
            background: #f6ffed;
            border: 1px solid #b7eb8f;
            color: #135200;
        }
        
        .alert-warning {
            background: #fffbe6;
            border: 1px solid #ffe58f;
            color: #ad6800;
        }
        
        .alert-danger {
            background: #fff2f0;
            border: 1px solid #ffccc7;
            color: #a8071a;
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        
        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-btn {
            width: 100%;
            padding: 20px;
            margin: 10px 0;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            color: white;
            transition: all 0.3s ease;
        }
        
        .modal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>🏠 Family Hub</h1>
            <div class="status-badges">
                <div class="status-badge active">
                    <span id="userRoleDisplay">👤 Loading...</span>
                </div>
                <div class="status-badge">
                    <span>👶 Nanny: Off</span>
                </div>
                <div class="status-badge">
                    <span>📅 Week 47</span>
                </div>
            </div>
        </div>
    </div>
    
    <nav class="tab-nav">
        <div class="tab-nav-content">
            <button class="tab-btn active" onclick="switchTab('dashboard', event)">
                <span>📊</span> Dashboard
            </button>
            <button class="tab-btn" onclick="switchTab('schedule', event)">
                <span>📅</span> Schedule Coordinator
            </button>
            <button class="tab-btn" onclick="switchTab('nanny', event)">
                <span>⏰</span> Nanny Tracker
            </button>
            <button class="tab-btn" onclick="switchTab('activities', event)">
                <span>🎯</span> Activities
            </button>
            <button class="tab-btn equity-tab-btn" onclick="switchTab('equity', event)">
                <span>⚖️</span> Parent Equity
            </button>
            <button class="tab-btn settings-tab-btn" onclick="switchTab('settings', event)">
                <span>⚙️</span> Settings
            </button>
        </div>
    </nav>
    
    <div class="container">
        <!-- Dashboard Tab -->
        <div id="dashboard-tab" class="tab-content active">
            <div class="alert alert-info">
                <span>💡</span>
                <span><strong>Good morning!</strong> You have 2 meetings today. Nanny arrives at 9am. Rhea takes over at 5pm.</span>
            </div>
            
            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <h3>This Week's Coverage</h3>
                    <div class="value">87%</div>
                    <div class="subtitle">3 gaps to address</div>
                </div>
                <div class="dashboard-card parent-balance-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <h3>Parent Balance</h3>
                    <div class="value">52/48</div>
                    <div class="subtitle">You / Rhea</div>
                </div>
                <div class="dashboard-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                    <h3>Nanny Hours</h3>
                    <div class="value">32.5</div>
                    <div class="subtitle">This week</div>
                </div>
                <div class="dashboard-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                    <h3>Next Handoff</h3>
                    <div class="value">5:00 PM</div>
                    <div class="subtitle">Rhea takes over</div>
                </div>
            </div>
            
            <div class="card">
                <h2>📅 Today's Schedule</h2>
                <div class="today-schedule">
                    <div class="schedule-timeline">
                        <div class="timeline-item">
                            <div class="timeline-time">8:00 AM</div>
                            <div class="timeline-content">
                                Morning routine
                                <span class="timeline-who">You</span>
                            </div>
                        </div>
                        <div class="timeline-item current">
                            <div class="timeline-time">9:00 AM</div>
                            <div class="timeline-content">
                                Nanny arrives
                                <span class="timeline-who">Sarah</span>
                            </div>
                        </div>
                        <div class="timeline-item">
                            <div class="timeline-time">10:00 AM</div>
                            <div class="timeline-content">
                                Your team standup
                                <span class="timeline-who">Meeting</span>
                            </div>
                        </div>
                        <div class="timeline-item">
                            <div class="timeline-time">12:00 PM</div>
                            <div class="timeline-content">
                                Kids lunch & nap
                                <span class="timeline-who">Sarah</span>
                            </div>
                        </div>
                        <div class="timeline-item">
                            <div class="timeline-time">2:00 PM</div>
                            <div class="timeline-content">
                                Rhea's client call
                                <span class="timeline-who">Rhea Busy</span>
                            </div>
                        </div>
                        <div class="timeline-item">
                            <div class="timeline-time">4:00 PM</div>
                            <div class="timeline-content">
                                Soccer practice
                                <span class="timeline-who">Activity</span>
                            </div>
                        </div>
                        <div class="timeline-item">
                            <div class="timeline-time">5:00 PM</div>
                            <div class="timeline-content">
                                Nanny leaves - Handoff
                                <span class="timeline-who">Rhea</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h2>⚡ Quick Actions</h2>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-primary">Request Coverage</button>
                    <button class="btn btn-success">Log Activity</button>
                    <button class="btn btn-warning">Update Schedule</button>
                    <button class="btn btn-danger">Emergency Contact</button>
                </div>
            </div>
        </div>
        
        <!-- Schedule Coordinator Tab -->
        <div id="schedule-tab" class="tab-content">
            <div class="card">
                <h2>🗓️ Weekly Schedule Overview</h2>
                <p style="color: #718096; margin-bottom: 20px;">
                    Layered view of all calendars. Green = covered, Red = gap, Yellow = partial coverage
                </p>
                
                <div class="calendar-container">
                    <div class="calendar-grid">
                        <div class="calendar-header">Time</div>
                        <div class="calendar-header">Monday</div>
                        <div class="calendar-header">Tuesday</div>
                        <div class="calendar-header">Wednesday</div>
                        <div class="calendar-header">Thursday</div>
                        <div class="calendar-header">Friday</div>
                        
                        <div class="calendar-label">You</div>
                        <div class="calendar-cell busy">Meeting 10-12</div>
                        <div class="calendar-cell available">Free</div>
                        <div class="calendar-cell busy">Deep work 9-2</div>
                        <div class="calendar-cell partial">Call at 3pm</div>
                        <div class="calendar-cell available">WFH</div>
                        
                        <div class="calendar-label">Rhea</div>
                        <div class="calendar-cell available">Free AM</div>
                        <div class="calendar-cell busy">Client 10-3</div>
                        <div class="calendar-cell available">Free</div>
                        <div class="calendar-cell busy">Workshop</div>
                        <div class="calendar-cell partial">Busy AM</div>
                        
                        <div class="calendar-label">Nanny</div>
                        <div class="calendar-cell nanny-suggested">9am-5pm ✓</div>
                        <div class="calendar-cell nanny-suggested">9am-6pm ✓</div>
                        <div class="calendar-cell nanny-suggested">9am-3pm ✓</div>
                        <div class="calendar-cell">Off</div>
                        <div class="calendar-cell nanny-suggested">10am-2pm ✓</div>
                        
                        <div class="calendar-label">Kids</div>
                        <div class="calendar-cell">School</div>
                        <div class="calendar-cell partial">Soccer 4pm</div>
                        <div class="calendar-cell">School</div>
                        <div class="calendar-cell partial">Music 5pm</div>
                        <div class="calendar-cell">School</div>
                        
                        <div class="calendar-label">Coverage</div>
                        <div class="calendar-cell available">
                            <span class="coverage-indicator">✅</span>
                        </div>
                        <div class="calendar-cell available">
                            <span class="coverage-indicator">✅</span>
                        </div>
                        <div class="calendar-cell available">
                            <span class="coverage-indicator">✅</span>
                        </div>
                        <div class="calendar-cell partial">
                            <span class="coverage-indicator">⚠️</span>
                        </div>
                        <div class="calendar-cell partial">
                            <span class="coverage-indicator">⚠️</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="ai-suggestion">
                <h3>🤖 AI Schedule Optimization</h3>
                <p style="margin-bottom: 15px;">Based on your calendars, here's the optimal nanny schedule for next week:</p>
                <ul>
                    <li><strong>Monday:</strong> 9am-5pm (both parents have morning meetings)</li>
                    <li><strong>Tuesday:</strong> 9am-6pm (extended for soccer practice + Rhea's client)</li>
                    <li><strong>Wednesday:</strong> 9am-3pm (you're both free after 3)</li>
                    <li><strong>Thursday:</strong> Skip or 2-5pm only (light day, save money)</li>
                    <li><strong>Friday:</strong> 10am-2pm (just covering Rhea's morning)</li>
                </ul>
                <p style="margin-top: 15px;"><strong>Estimated cost:</strong> $600 (30 hours × $20/hr)</p>
                <p><strong>Savings:</strong> $160 vs full-time coverage</p>
                <div class="suggestion-actions">
                    <button class="btn btn-primary">Accept & Schedule</button>
                    <button class="btn btn-warning">Adjust Hours</button>
                    <button class="btn">Dismiss</button>
                </div>
            </div>
        </div>
        
        <!-- Nanny Tracker Tab -->
        <div id="nanny-tab" class="tab-content">
            <div class="card">
                <h2>⏰ Time Tracking</h2>
                
                <!-- Live Timer Display -->
                <div style="text-align: center; margin: 20px 0;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                                color: white; 
                                padding: 30px; 
                                border-radius: 15px; 
                                box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
                        <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 10px;">
                            CURRENT SHIFT
                        </div>
                        <div id="liveTimer" style="font-size: 3.5em; font-weight: bold; font-family: 'SF Mono', Monaco, monospace;">
                            00:00:00
                        </div>
                        <div id="clockInTime" style="font-size: 0.9em; opacity: 0.9; margin-top: 10px;">
                            Not clocked in
                        </div>
                    </div>
                </div>
                
                <div style="text-align: center; margin: 30px 0;">
                    <button id="clockInBtn" class="btn btn-success btn-large" onclick="clockIn()">Clock In</button>
                    <button id="clockOutBtn" class="btn btn-danger btn-large" onclick="clockOut()" style="display: none;">Clock Out</button>
                </div>
                <div class="time-tracker">
                    <button class="btn btn-warning">Manual Entry</button>
                    <button class="btn btn-primary">View History</button>
                </div>
            </div>
     <!-- Weekly Summary -->       
            <div class="card">
                <h2>📊 This Week's Summary</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Clock In</th>
                            <th>Clock Out</th>
                            <th>Hours</th>
                            <th>Earnings</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Mon 11/18</td>
                            <td>9:00 AM</td>
                            <td>5:00 PM</td>
                            <td>8.0</td>
                            <td>$160</td>
                            <td>Regular day</td>
                        </tr>
                        <tr>
                            <td>Tue 11/19</td>
                            <td>9:00 AM</td>
                            <td>6:00 PM</td>
                            <td>9.0</td>
                            <td>$180</td>
                            <td>Stayed for soccer</td>
                        </tr>
                    </tbody>
                </table>
                <div class="payment-summary" style="text-align: center; margin-top: 20px;">
                    <div id="weeklyTotal" style="font-size: 2em; color: #667eea; margin: 10px 0;">
                          Total: $0.00 (0.0 hours)
                    </div>
                    <button id="payBtn" class="btn btn-primary btn-large family-only" 
                            onclick="generateVenmoPaymentWithTracking()">
                        Generate Venmo Payment
                    </button>
                </div>
            </div>
            
<!-- Payment History -->
            <div class="card">
                  <h2>💰 Payment History</h2>
                
                  <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px; flex-wrap:wrap;">
                    <select id="phStatus" class="btn" style="background:#f7fafc; color:#4a5568;">
                      <option value="all">All</option>
                      <option value="paid">Paid</option>
                      <option value="unpaid">Unpaid</option>
                    </select>
                    <select id="phPageSize" class="btn" style="background:#f7fafc; color:#4a5568;">
                      <option>10</option><option selected>20</option><option>50</option>
                    </select>
                    <button class="btn btn-primary" onclick="loadPaymentHistoryUI()">Refresh</button>
                    <div id="phSummary" style="margin-left:auto; color:#667eea;"></div>
                  </div>
                
                  <div id="paymentHistory" style="overflow-x:auto;">
                    <div class="loading">Loading payment history...</div>
                  </div>
                
                  <div id="phPager" style="display:flex; justify-content:space-between; margin-top:10px;">
                    <button class="btn" id="phPrev" onclick="phPrevPage()">← Prev</button>
                    <button class="btn" id="phNext" onclick="phNextPage()">Next →</button>
                  </div>
                </div>
        </div>
        
        <!-- Activities Tab -->
        <div id="activities-tab" class="tab-content">
            <div class="card">
                <h2>🎯 Kids' Activities</h2>
                <button class="btn btn-primary" style="margin-bottom: 20px;">+ Add Activity</button>
                
                <ul class="activity-list">
                    <li class="activity-item">
                        <div class="activity-info">
                            <div class="activity-time">Tuesday 4:00 PM</div>
                            <div class="activity-name">Soccer Practice</div>
                            <div class="activity-details">
                                Location: Community Park | Coach: Mike | Bring: Water, cleats
                            </div>
                        </div>
                        <span class="activity-status upcoming">Tomorrow</span>
                    </li>
                </ul>
            </div>
        </div>
        
        <!-- Parent Equity Tab -->
        <div id="equity-tab" class="tab-content">
            <div class="card">
                <h2>⚖️ Parent Coverage Balance</h2>
                <h3>This Week</h3>
                <div class="equity-bar">
                    <div class="equity-segment equity-you" style="width: 52%;">You: 52%</div>
                    <div class="equity-segment equity-partner" style="width: 48%;">Rhea: 48%</div>
                </div>
                <div class="equity-legend">
                    <div class="equity-legend-item">
                        <div class="legend-color equity-you"></div>
                        <span>You: 18.2 hours</span>
                    </div>
                    <div class="equity-legend-item">
                        <div class="legend-color equity-partner"></div>
                        <span>Rhea: 16.8 hours</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Settings Tab -->
        <div id="settings-tab" class="tab-content">
            <div class="card">
                <h2>⚙️ System Settings</h2>
                <div class="form-row">
                    <div class="input-group">
                        <label>Nanny Name</label>
                        <input type="text" value="Sarah" id="nannyName">
                    </div>
                    <div class="input-group">
                        <label>Hourly Rate</label>
                        <input type="number" value="20" id="hourlyRate">
                    </div>
                    <div class="input-group">
                        <label>Venmo Username</label>
                        <input type="text" placeholder="@username" id="venmoUsername">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
            </div>
            
            <div class="card">
                <h2>🔧 Technical Settings</h2>
                <div class="input-group">
                    <label>Google Script URL</label>
                    <input type="text" id="scriptUrlSetting" placeholder="https://script.google.com/macros/s/..." style="width: 100%;">
                    <small style="color: #666;">Your Google Apps Script deployment URL</small>
                </div>
                <div class="form-row">
                    <div class="input-group">
                        <label>Your Name</label>
                        <input type="text" id="yourNameSetting" placeholder="Your name">
                    </div>
                    <div class="input-group">
                        <label>Partner's Name</label>
                        <input type="text" id="partnerNameSetting" placeholder="Partner's name">
                    </div>
                </div>
                <button class="btn btn-success" onclick="saveAllSettings()">Update All Settings</button>
            </div>
        </div>
    </div>
    
    <!-- Quick Action Button -->
    <div class="quick-actions">
        <button class="fab" onclick="showQuickAdd()">+</button>
    </div>
    
    <script>
        const fmtUSD = n => new Intl.NumberFormat('en-US', { style:'currency', currency:'USD' }).format(Number(n) || 0);
const sanitizeVenmo = h => (h || '').toString().trim().replace(/^@+/, '');
        // ===== CONFIGURATION - UPDATE THESE VALUES =====
        // ===== CONFIGURATION - HARDCODE YOUR SCRIPT URL HERE =====
const CONFIG = {
    // THIS IS THE ONLY THING YOU NEED TO HARDCODE
    scriptUrl: 'https://script.google.com/macros/s/AKfycbz0D5lzPKspVmhzhliFK26yzTrtUMaATAmxJOLf4nlPM78TwRe8II7cQi6C6VVGS5AFsQ/exec',
    
    // Everything else loads from Google Sheets
    nannyName: '',
    hourlyRate: 20,
    yourName: '',
    partnerName: '',
    venmoUsername: '',
    familyPIN: '1234',
    userRole: null
};

let PH_STATE = { page: 1, pageSize: 20, status: 'all', total: 0 };

function phFmt(n){ return new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'}).format(n||0); }
function phBadge(paid){
  return paid
    ? '<span style="background:#48bb78;color:white;padding:4px 10px;border-radius:999px;font-size:.8em;">Paid</span>'
    : '<span style="background:#f56565;color:white;padding:4px 10px;border-radius:999px;font-size:.8em;">Unpaid</span>';
}
// Re-sync the running clock from server state (works across tabs/devices)
async function syncClockFromServer() {
  const status = await callGoogleScript('getCurrentStatus', { name: CONFIG.nannyName });
  if (!status) return;

  if (status.status === 'clocked_in' && status.since) {
    currentClockInTime = new Date(status.since);  // authoritative server start
    updateClockDisplay(true, currentClockInTime);
    startTimer();                                  // restarts (clears old interval inside)
  } else {
    updateClockDisplay(false, null);
    stopTimer();
  }
}
        function phComposeReminder(weekStartISO, hours, amount, nannyName) {
  const ws = new Date(weekStartISO);
  const we = new Date(ws); we.setDate(ws.getDate() + 6);
  const range = `${ws.toLocaleDateString()}–${we.toLocaleDateString()}`;
  const hrs = Number(hours) || 0;
  const amt = Number(amount) || (hrs * (Number(CONFIG.hourlyRate)||20));
  // Sprinkle a little chankla humor 😄
  return `Hey! Quick reminder 💬\n\n` +
         `Week: ${range}\nHours: ${hrs.toFixed(1)}\nAmount: $${amt.toFixed(2)}\n\n` +
         `When you get a sec, can you ping me? (no chankla plz 😅)`;
}

async function phRemind(weekStartISO, hours, amount, nannyName) {
  const msg = phComposeReminder(weekStartISO, hours, amount, nannyName);

  // 1) Try native share (best UX on mobile)
  if (navigator.share) {
    try {
      await navigator.share({ text: msg });
      return;
    } catch (_) {/* fall through */}
  }

  // 2) Try SMS deep link (many mobile browsers)
  // (some platforms prefer 'sms:&body=', some 'sms:?&body=' — we try the common one)
  const smsUrl = `sms:&body=${encodeURIComponent(msg)}`;
  if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
    try { window.location.href = smsUrl; return; } catch(_) {/* fall through */}
  }

  // 3) Desktop fallback: copy to clipboard so nanny can paste in a text
  try {
    await navigator.clipboard.writeText(msg);
    alert('Reminder text copied to clipboard — paste it into your messaging app.');
  } catch {
    prompt('Copy this reminder and send it:', msg);
  }
}
        function renderPaymentHistory(payments, totalCount) {
  const container = document.getElementById('paymentHistory');
  const summary   = document.getElementById('phSummary');
  const role = (CONFIG.userRole || '').toLowerCase();
  const isPriv = role === 'admin' || role === 'family';

  if (!payments || payments.length === 0) {
    container.innerHTML = '<p style="color:#666;">No payment history.</p>';
    summary.textContent = '';
    return;
  }

  let html = `
  <table style="width:100%; border-collapse:collapse;">
    <thead>
      <tr>
        <th>Week</th>
        <th>Status</th>
        <th>Hours</th>
        <th>Amount</th>
        <th>Paid Date</th>
        <th>Method</th>
        <th>Ref</th>
        <th style="text-align:right;">Actions</th>
      </tr>
    </thead>
    <tbody>
  `;

  let subtotal = 0, subhours = 0;

  payments.forEach(p => {
    const paidDate = p.paidDate ? new Date(p.paidDate).toLocaleDateString() : '—';

    // Role-based Actions cell
    const actions = (() => {
      if (p.isPaid) {
        return isPriv
          ? `
            <button class="btn" onclick="phEditRef('${p.weekStart}','${p.nanny||''}','${(p.reference||'').replace(/"/g,'&quot;')}')">Edit ref</button>
            <button class="btn btn-warning" onclick="phUnmarkPaid('${p.weekStart}','${p.nanny||''}')">Mark Unpaid</button>
          `
          : '—';
      } else {
        if (isPriv) {
          return `<button class="btn btn-primary" onclick="generateVenmoPaymentWithTracking()">Record Payment</button>`;
        }
        if (role === 'nanny') {
          return `
            <button class="btn" onclick="phRemind('${p.weekStart}','${p.hours||0}','${p.amount||0}','${p.nanny||CONFIG.nannyName||'Nanny'}')">
              Remind
            </button>
          `;
        }
        return '—';
      }
    })();

    html += `
      <tr>
        <td>${p.weekLabel}</td>
        <td>${phBadge(p.isPaid)}</td>
        <td>${(p.hours||0).toFixed(1)}</td>
        <td>${phFmt(p.amount||0)}</td>
        <td>${paidDate}</td>
        <td>${p.method||'—'}</td>
        <td style="max-width:160px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${p.reference||'—'}</td>
        <td style="text-align:right;">${actions}</td>
      </tr>
    `;
    subtotal += p.amount || 0;
    subhours += p.hours  || 0;
  });

  html += `
    </tbody>
  </table>
  <div style="margin-top:10px; text-align:right; color:#4a5568;">
    Page subtotal: <strong>${phFmt(subtotal)}</strong> · ${subhours.toFixed(1)} hrs
  </div>`;

  container.innerHTML = html;

  // summary + pager
  PH_STATE.total = totalCount || 0;
  const first = (PH_STATE.page - 1) * PH_STATE.pageSize + 1;
  const last  = Math.min(PH_STATE.page * PH_STATE.pageSize, PH_STATE.total);
  summary.textContent = PH_STATE.total ? `Showing ${first}–${last} of ${PH_STATE.total}` : '';

  const prevBtn = document.getElementById('phPrev');
  const nextBtn = document.getElementById('phNext');
  if (prevBtn) prevBtn.disabled = PH_STATE.page <= 1;
  if (nextBtn) nextBtn.disabled = last >= PH_STATE.total;
}
async function loadPaymentHistoryUI() {
  // read controls
  const statusEl = document.getElementById('phStatus');
  const sizeEl   = document.getElementById('phPageSize');
  PH_STATE.status   = (statusEl?.value || 'all').toLowerCase();
  PH_STATE.pageSize = parseInt(sizeEl?.value || '20', 10);
  PH_STATE.page     = Math.max(1, PH_STATE.page);

  const resp = await callGoogleScript('getPaymentHistory', {
    status: PH_STATE.status,
    limit: String(PH_STATE.pageSize),
    page: String(PH_STATE.page)
  });

  if (!resp || !Array.isArray(resp.payments)) {
    renderPaymentHistory([], 0);
    return;
  }

  renderPaymentHistory(resp.payments, resp.total || 0);
}

function phPrevPage(){ if (PH_STATE.page > 1){ PH_STATE.page--; loadPaymentHistoryUI(); } }
function phNextPage(){
  const maxPage = Math.ceil((PH_STATE.total || 0) / (PH_STATE.pageSize || 20));
  if (PH_STATE.page < maxPage){ PH_STATE.page++; loadPaymentHistoryUI(); }
}


async function phUnmarkPaid(weekStartISO, nannyName) {
  if (!confirm('Mark this week as UNPAID?')) return;
  const res = await callGoogleScript('unmarkWeekPaid', {
    weekStart: new Date(weekStartISO).toISOString(),
    nannyName: nannyName || CONFIG.nannyName
  });
  if (res?.success) {
    await loadNannyData();     // refresh PAID state on the main card
    await loadPaymentHistoryUI();
  } else {
    alert(res?.message || 'Could not unmark');
  }
}

async function phEditRef(weekStartISO, nannyName, currentRef) {
  const reference = prompt('Edit payment reference:', currentRef || '') || '';
  // lightweight: redo markWeekPaid with same amounts/hours? or just update row?
  // For now, re-mark with same hours/amount from week totals:
  const ws = new Date(weekStartISO);
  ws.setHours(0,0,0,0);
  // pull week totals quickly from entries
  const r = await callGoogleScript('getTimeEntries', { weekOnly:'true', name: nannyName || CONFIG.nannyName });
  const hours = (r?.entries||[]).filter(e => e.clockOut)
    .reduce((s,e)=>s+(parseFloat(e.hours)||0),0);
  const total = hours * (Number(CONFIG.hourlyRate)||20);
  const res = await callGoogleScript('markWeekPaid', {
    weekStart: ws.toISOString(),
    nannyName: nannyName || CONFIG.nannyName,
    hours: hours.toFixed(2),
    amount: total.toFixed(2),
    method: 'Venmo',
    reference
  });
  if (res?.success) {
    await loadNannyData();
    await loadPaymentHistoryUI();
  } else {
    alert('Could not update reference');
  }
}
        
// ===== NO MORE LOCALSTORAGE - EVERYTHING FROM SHEETS =====
async function initializeApp() {
    // 1. Determine role from URL
    const urlParams = new URLSearchParams(window.location.search);
    const role = urlParams.get('role');
    const setupKey = urlParams.get('setup');
    
    // Set role based on URL
    if (setupKey === 'admin123') {
        CONFIG.userRole = 'admin';
    } else if (role === 'nanny') {
        CONFIG.userRole = 'nanny';
    } else if (role === 'family') {
        CONFIG.userRole = 'family';
    } else {
        // No role in URL - show selection
        showRoleSelection();
        return;
    }
    
    // 2. Apply role restrictions immediately
    applyRoleRestrictions();
    
    // 3. Load settings from Google Sheets (not localStorage!)
    try {
        const settings = await callGoogleScript('getSettings');
        
        if (settings && settings.configured) {
            // Apply settings from Sheets
            CONFIG.nannyName = settings.nannyName || 'Nanny';
            CONFIG.hourlyRate = parseFloat(settings.hourlyRate) || 20;
            CONFIG.yourName = settings.yourName || 'Parent 1';
            CONFIG.partnerName = settings.partnerName || 'Parent 2';
            CONFIG.venmoUsername = settings.venmoUsername || '';
            CONFIG.familyPIN = settings.familyPIN || '1234';
            
            console.log('✅ Settings loaded from Google Sheets');
        } else {
            // No settings in Sheets yet
            if (CONFIG.userRole === 'admin') {
                showSetupWizard();
                return;
            } else {
                console.log('Waiting for admin to configure settings');
            }
        }
    } catch (error) {
        console.error('Error loading settings:', error);
    }
    
    // 4. Initialize the app
    await loadDashboard();
    console.log('✅ Family Hub ready!');
}

// ===== SAVE SETTINGS TO SHEETS ONLY =====
async function saveSettings() {
    const settings = {
        nannyName: document.getElementById('nannyName').value,
        hourlyRate: document.getElementById('hourlyRate').value,
        venmoUsername: document.getElementById('venmoUsername').value,
        yourName: CONFIG.yourName,
        partnerName: CONFIG.partnerName,
        familyPIN: CONFIG.familyPIN
    };
    
    // Save to Google Sheets (no localStorage!)
    const result = await callGoogleScript('saveSettings', settings);
    
    if (result && result.success) {
        // Update CONFIG with new values
        Object.assign(CONFIG, settings);
        alert('✅ Settings saved to cloud! All users will see these changes.');
    } else {
        alert('Error saving settings');
    }
}

// ===== SIMPLIFIED COMPLETE SETUP =====
async function completeSetup() {
    const scriptUrl = document.getElementById('setupScriptUrl').value;
    const nannyName = document.getElementById('setupNannyName').value;
    const hourlyRate = document.getElementById('setupHourlyRate').value;
    const yourName = document.getElementById('setupYourName').value;
    const partnerName = document.getElementById('setupPartnerName').value;
    
    if (!scriptUrl || !nannyName) {
        alert('Please fill in required fields');
        return;
    }
    
    // For first setup, we need to hardcode the script URL
    alert('⚠️ IMPORTANT: You need to hardcode this Script URL in your index.html file on GitHub:\n\n' + scriptUrl);
    
    // Save settings to Google Sheets
    const settings = {
        nannyName: nannyName,
        hourlyRate: hourlyRate,
        yourName: yourName || 'Parent 1',
        partnerName: partnerName || 'Parent 2',
        scriptUrl: scriptUrl
    };
    
    CONFIG.scriptUrl = scriptUrl; // Temporarily set for this session
    
    const result = await callGoogleScript('saveSettings', settings);
    
    if (result && result.success) {
        const modal = document.querySelector('.modal-overlay');
        if (modal) modal.remove();
        
        alert('✅ Setup complete! Settings saved to cloud.');
        location.reload();
    }
}

// ===== REPLACE DOMContentLoaded =====
document.addEventListener('DOMContentLoaded', () => {
    if (CONFIG.scriptUrl && CONFIG.scriptUrl !== 'https://script.google.com/macros/s/YOUR_ACTUAL_SCRIPT_ID_HERE/exec') {
        // Script URL is configured - initialize
        initializeApp();
    } else {
        // Script URL not configured
        alert('⚠️ App not configured!\n\n1. Edit index.html on GitHub\n2. Replace YOUR_ACTUAL_SCRIPT_ID_HERE with your Google Script ID\n3. Commit and push changes');
    }
});
   
// ===== ROLE-BASED ACCESS CONTROL =====
function applyRoleRestrictions() {
    const role = CONFIG.userRole;
    console.log('Applying restrictions for role:', role);
    
    // Update user role display
    const roleDisplay = document.getElementById('userRoleDisplay');
    if (roleDisplay) {
        if (role === 'nanny') {
            roleDisplay.textContent = '👶 Logged in as: Nanny';
        } else if (role === 'family') {
            roleDisplay.textContent = '👨‍👩‍👧 Family Member';
        } else if (role === 'admin') {
            roleDisplay.textContent = '🔧 Admin Mode';
        }
    }
    
    if (role === 'nanny') {
        // Hide tabs nanny shouldn't see
        const equityTab = document.querySelector('.equity-tab-btn');
        const settingsTab = document.querySelector('.settings-tab-btn');
        const scheduleTab = document.querySelector('.tab-btn:nth-child(2)');
        
        if (equityTab) equityTab.style.display = 'none';
        if (settingsTab) settingsTab.style.display = 'none';
        if (scheduleTab) scheduleTab.style.display = 'none';
        
        // Hide parent balance card
        const parentBalanceCard = document.querySelector('.parent-balance-card');
        if (parentBalanceCard) parentBalanceCard.style.display = 'none';
        
        // Hide payment button
        const familyOnlyElements = document.querySelectorAll('.family-only');
        familyOnlyElements.forEach(el => el.style.display = 'none');
    }
}

function showRoleSelection() {
    const existingModal = document.querySelector('.modal-overlay');
    if (existingModal) existingModal.remove();
    
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    
    modal.innerHTML = `
        <div class="modal-content" style="text-align: center;">
            <h2 style="color: #667eea; margin-bottom: 30px;">Welcome to Family Hub</h2>
            <p style="margin-bottom: 30px; color: #666;">Please select who you are:</p>
            
            <button onclick="window.location.href='?role=family'" class="modal-btn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                👨‍👩‍👧 Family Member
            </button>
            
            <button onclick="window.location.href='?role=nanny'" class="modal-btn" style="background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);">
                👶 Nanny / Caregiver
            </button>
        </div>
    `;
    
    document.body.appendChild(modal);
}

function showSetupWizard() {
    alert('Go to Settings tab to configure the app');
    switchTab('settings', null);
}

// ===== GOOGLE SHEETS INTEGRATION =====
async function callGoogleScript(action, params = {}) {
    if (!CONFIG.scriptUrl) {
        console.error('Script URL not configured');
        return null;
    }

    const url = new URL(CONFIG.scriptUrl);
    url.searchParams.append('action', action);
    Object.keys(params).forEach(k => url.searchParams.append(k, params[k]));
    url.searchParams.append('_ts', Date.now());

    try {
        const res = await fetch(url.toString());
        return await res.json();
    } catch (err) {
        console.error('Error calling script:', err);
        return null;
    }
}

// Continue with the rest of your functions (switchTab, loadDashboard, etc.)
// But DELETE the duplicate initialization at the end

        // ===== TAB MANAGEMENT =====
        function switchTab(tabName, event) {
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.getElementById(`${tabName}-tab`).classList.add('active');

  const btn = event?.currentTarget || event?.target?.closest('button');
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');

  loadTabData(tabName);
        }
        
        async function loadTabData(tabName) {
            switch(tabName) {
                case 'dashboard':
                    await loadDashboard();
                    break;
                case 'nanny':
                    await loadNannyData();
                    await loadPaymentHistoryUI(); // ← add this
                    break;
                case 'settings':
                    loadSettings();
                    break;
            }
        }
        
        // ===== DASHBOARD FUNCTIONS =====
        async function loadDashboard() {
            console.log('Loading dashboard...');
        }
        
        // ===== NANNY TRACKER FUNCTIONS =====
        let timerInterval = null;
        let currentClockInTime = null;
        
        async function clockIn() {
            const result = await callGoogleScript('clockIn', {
                name: CONFIG.nannyName
            });
            
            if (result && result.success) {
                currentClockInTime = new Date(result.time);
                updateClockDisplay(true, currentClockInTime);
                startTimer();
                await loadNannyData();
            } else {
                alert('Error clocking in. Check that the Google Script is configured.');
            }
        }
        
        async function clockOut() {
            const result = await callGoogleScript('clockOut', {
                name: CONFIG.nannyName
            });
            
            if (result && result.success) {
                stopTimer();
                updateClockDisplay(false, null);
                alert(`✅ Clocked out! Worked ${result.hours} hours today.`);
                await loadNannyData();
            } else {
                alert('Error clocking out. Please try again.');
            }
        }
        
        function updateClockDisplay(isClockedIn, clockInTime) {
            const clockInBtn = document.getElementById('clockInBtn');
            const clockOutBtn = document.getElementById('clockOutBtn');
            const clockInTimeDisplay = document.getElementById('clockInTime');
            const timerDisplay = document.getElementById('liveTimer');
            
            if (isClockedIn) {
                if (clockInBtn) clockInBtn.style.display = 'none';
                if (clockOutBtn) clockOutBtn.style.display = 'inline-block';
                if (clockInTimeDisplay && clockInTime) {
                    clockInTimeDisplay.textContent = `Clocked in at ${clockInTime.toLocaleTimeString('en-US', { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    })}`;
                }
            } else {
                if (clockInBtn) clockInBtn.style.display = 'inline-block';
                if (clockOutBtn) clockOutBtn.style.display = 'none';
                if (clockInTimeDisplay) clockInTimeDisplay.textContent = 'Not clocked in';
                if (timerDisplay) timerDisplay.textContent = '00:00:00';
            }
        }
        
        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                if (!currentClockInTime) return;
                const now = new Date();
                const diff = now - currentClockInTime;
                
                const hours = Math.floor(diff / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                
                const display = 
                    String(hours).padStart(2, '0') + ':' +
                    String(minutes).padStart(2, '0') + ':' +
                    String(seconds).padStart(2, '0');
                
                const timerElement = document.getElementById('liveTimer');
                if (timerElement) {
                    timerElement.textContent = display;
                }
            }, 1000);
        }
        
        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            currentClockInTime = null;
        }
        async function loadJSON(action, params = {}) {
  const url = new URL(CONFIG.scriptUrl);
  url.searchParams.set('action', action);
  Object.entries(params).forEach(([k,v]) => url.searchParams.set(k, v));
  const res = await fetch(url);
  if (!res.ok) throw new Error(`Request failed: ${res.status}`);
  return res.json();
}
async function loadNannyData() {
  // 1) Check clock-in status
  const status = await callGoogleScript('getCurrentStatus', { name: CONFIG.nannyName });
  if (status?.status === 'clocked_in') {
    currentClockInTime = new Date(status.since);
    updateClockDisplay(true, currentClockInTime);
    startTimer();
  } else {
    updateClockDisplay(false, null);
    stopTimer();
  }

  // 2) Get week's entries
  const res = await callGoogleScript('getTimeEntries', { weekOnly: true, name: CONFIG.nannyName });
  const entries = res?.entries || [];
  const done = entries.filter(e => e.clockOut);

  // 3) Check if this week is paid
  const weekStart = new Date();
  weekStart.setDate(weekStart.getDate() - weekStart.getDay());
  weekStart.setHours(0, 0, 0, 0);
  
  const paymentStatus = await callGoogleScript('checkWeekPaymentStatus', {
    weekStart: weekStart.toISOString(),
    nannyName: CONFIG.nannyName
  });

  // 4) Update table
  const tbody = document.querySelector('#nanny-tab tbody');
  if (tbody) {
    tbody.innerHTML = '';
    for (const e of done) {
      const hours = parseFloat(e.hours) || 0;
      const pay = hours * (CONFIG.hourlyRate || 20);
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${new Date(e.date).toLocaleDateString()}</td>
        <td>${new Date(e.clockIn).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</td>
        <td>${new Date(e.clockOut).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</td>
        <td>${hours.toFixed(1)}</td>
        <td>$${pay.toFixed(2)}</td>
        <td>${e.notes || ''}</td>
      `;
      tbody.appendChild(tr);
    }
  }

  // 5) Update totals and payment button based on status
  const totalHours = done.reduce((sum, e) => sum + (parseFloat(e.hours) || 0), 0);
  const totalPay = totalHours * (CONFIG.hourlyRate || 20);
  const totalEl = document.getElementById('weeklyTotal');
  const payBtn = document.getElementById('payBtn');
  
  if (paymentStatus && paymentStatus.isPaid) {
    // Week is paid - show green checkmark
    if (totalEl) {
      const paidDate = new Date(paymentStatus.paymentDate).toLocaleDateString();
      totalEl.innerHTML = `
        <div style="color: #48bb78; font-size: 1.5em;">✓ PAID</div>
        <div style="font-size: 0.8em; color: #666;">
          $${paymentStatus.amount.toFixed(2)} on ${paidDate}
        </div>
      `;
    }
    if (payBtn) {
      payBtn.innerHTML = '✓ Week Paid';
      payBtn.className = 'btn btn-success btn-large family-only';
      payBtn.disabled = true;
      payBtn.style.opacity = '0.7';
    }
  } else {
    // Week not paid - show normal
    if (totalEl) {
      totalEl.textContent = `Total: $${totalPay.toFixed(2)} (${totalHours.toFixed(1)} hours)`;
    }
    if (payBtn) {
      payBtn.innerHTML = 'Generate Venmo Payment';
      payBtn.className = 'btn btn-primary btn-large family-only';
      payBtn.disabled = false;
      payBtn.style.opacity = '1';
    }
  }
}
        // ===== SETTINGS FUNCTIONS =====
async function saveSettings() {
    const nannyName = document.getElementById('nannyName').value;
    const hourlyRate = document.getElementById('hourlyRate').value;
    const venmoRaw = document.getElementById('venmoUsername').value;
    
    const venmoClean = sanitizeVenmo(venmoRaw);
    
    // Save to Google Sheets for everyone
    const result = await callGoogleScript('saveSettings', {
        nannyName: nannyName,
        hourlyRate: hourlyRate,
        venmoUsername: venmoClean,
        yourName: CONFIG.yourName,
        partnerName: CONFIG.partnerName,
        scriptUrl: CONFIG.scriptUrl
    });
    
    if (result && result.success) {
        // Update local CONFIG
        CONFIG.nannyName = nannyName;
        CONFIG.hourlyRate = parseFloat(hourlyRate);
        CONFIG.venmoUsername = venmoClean;
        
        // Also update localStorage as backup
        localStorage.setItem('nannyName', nannyName);
        localStorage.setItem('hourlyRate', hourlyRate);
        localStorage.setItem('venmoUsername', venmoClean);
        
        document.getElementById('venmoUsername').value = venmoClean ? '@' + venmoClean : '';
        
        alert('Settings saved for all users!');
        await loadDashboard(); // Refresh with new settings
    } else {
        alert('Error saving settings to cloud. Using local save only.');
        // Fallback to local save
        localStorage.setItem('nannyName', nannyName);
        localStorage.setItem('hourlyRate', hourlyRate);
        localStorage.setItem('venmoUsername', venmoClean);
    }
}
        
        function loadSettings() {
            if (document.getElementById('nannyName')) {
                document.getElementById('nannyName').value = CONFIG.nannyName;
                document.getElementById('hourlyRate').value = CONFIG.hourlyRate;
                document.getElementById('venmoUsername').value = CONFIG.venmoUsername || '';
            }
            
            if (document.getElementById('scriptUrlSetting')) {
                document.getElementById('scriptUrlSetting').value = CONFIG.scriptUrl || '';
                document.getElementById('yourNameSetting').value = CONFIG.yourName || '';
                document.getElementById('partnerNameSetting').value = CONFIG.partnerName || '';
            }
        }
        
// ===== PAYMENT FUNCTIONS =====
async function generateVenmoPaymentWithTracking() {
  try {
    if (!CONFIG.scriptUrl) {
      alert('Google Script URL is not set. Add it in Settings.');
      return;
    }

    // 1) Read & validate Venmo handle
    const raw = (CONFIG.venmoUsername || '').trim();
    const handle = sanitizeVenmo(raw); // removes leading @
    if (!raw || /^@?username$/i.test(raw)) {
      alert('Set your real Venmo Username in Settings (e.g., @nickreitzin), then try again.');
      return;
    }

    // 2) Pull this week's completed shifts
    const rate = Number(CONFIG.hourlyRate) || 20;
    const res = await callGoogleScript('getTimeEntries', { weekOnly: true, name: CONFIG.nannyName });
    const entries = res?.entries || [];
    const done = entries.filter(e => e.clockOut);
    const hours = done.reduce((sum, e) => sum + (parseFloat(e.hours) || 0), 0);
    if (!hours) {
      alert('No completed hours recorded this week.');
      return;
    }
    const total = +(hours * rate).toFixed(2);

    // 3) Build week-of label (Sunday 00:00)
    const d = new Date();
    const weekStart = new Date(d);
    weekStart.setDate(d.getDate() - d.getDay());
    weekStart.setHours(0, 0, 0, 0);

    const note =
`Weekly payment for ${CONFIG.nannyName}
Week of ${weekStart.toLocaleDateString()}
Hours: ${hours.toFixed(1)}
Rate: ${fmtUSD(rate)}/hour
Total: ${fmtUSD(total)}`;

    // 4) Mobile → open Venmo app; otherwise copy note
    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    if (isMobile && handle) {
      const venmoUrl =
        `venmo://paycharge?txn=pay&recipients=${encodeURIComponent(handle)}` +
        `&amount=${encodeURIComponent(total.toFixed(2))}` +
        `&note=${encodeURIComponent(note)}`;
      const ok = confirm(`Pay ${fmtUSD(total)} to @${handle} via Venmo?\n\nOK = open Venmo · Cancel = copy details instead`);
      if (ok) {
        window.location.href = venmoUrl;
      } else {
        try { await navigator.clipboard.writeText(note); alert(`✅ Details copied.\n\n${note}`); }
        catch { prompt('Copy this payment message:', note); }
      }
    } else {
      try { await navigator.clipboard.writeText(note); alert(`✅ Details copied.\n\n${note}`); }
      catch { prompt('Copy this payment message:', note); }
    }

    // 5) Ask to mark as paid and record it
    const markPaid = confirm('After you send the payment, click OK to mark this week as PAID.');
    if (markPaid) {
      const reference = prompt('Enter Venmo transaction ID (optional):') || '';
      const result = await callGoogleScript('markWeekPaid', {
        weekStart: weekStart.toISOString(),
        nannyName: CONFIG.nannyName,
        hours: hours.toFixed(2),
        amount: total.toFixed(2),
        method: 'Venmo',
        reference
      });
      if (result && result.success) {
        alert('✅ Payment marked as complete!');
        await loadNannyData();       // refresh “PAID” state
        await loadPaymentHistoryUI();  // refresh history list (if visible)
      } else {
        alert('Could not save payment record.');
      }
    }
  } catch (err) {
    console.error('generateVenmoPaymentWithTracking error:', err);
    alert('Could not generate/record the payment. Check console for details.');
  }
}

// Add payment history view
function addPaymentHistorySection() {
  return `
    <div class="card">
      <h2>💰 Payment History</h2>
      <div id="paymentHistory">
        <div class="loading">Loading payment history...</div>
      </div>
      <button class="btn btn-primary" onclick="loadPaymentHistory()">
        View All Payment History
      </button>
    </div>
  `;
}

async function loadPaymentHistory() {
  const history = await callGoogleScript('getPaymentHistory');
  
  if (!history || !history.payments || history.payments.length === 0) {
    document.getElementById('paymentHistory').innerHTML = 
      '<p style="color: #666;">No payment history yet.</p>';
    return;
  }
  
  let html = `
    <table style="width: 100%; margin-bottom: 20px;">
      <thead>
        <tr>
          <th>Week</th>
          <th>Hours</th>
          <th>Amount</th>
          <th>Paid Date</th>
          <th>Method</th>
        </tr>
      </thead>
      <tbody>
  `;
  
  // Show last 5 payments
  const recentPayments = history.payments.slice(0, 5);
  
  recentPayments.forEach(payment => {
    const weekStart = new Date(payment.weekStart).toLocaleDateString();
    const paidDate = new Date(payment.paidDate).toLocaleDateString();
    
    html += `
      <tr>
        <td>${weekStart}</td>
        <td>${payment.hours.toFixed(1)}</td>
        <td>$${payment.amount.toFixed(2)}</td>
        <td>${paidDate}</td>
        <td>${payment.method}</td>
      </tr>
    `;
  });
  
  html += '</tbody></table>';
  
  // Calculate totals
  const totalPaid = history.payments.reduce((sum, p) => sum + p.amount, 0);
  const totalHours = history.payments.reduce((sum, p) => sum + p.hours, 0);
  
  html += `
    <div style="text-align: center; padding: 20px; background: #f7fafc; border-radius: 8px;">
      <div style="color: #667eea; font-size: 1.2em;">
        Total Paid: $${totalPaid.toFixed(2)}
      </div>
      <div style="color: #666; font-size: 0.9em;">
        ${totalHours.toFixed(1)} hours over ${history.payments.length} weeks
      </div>
    </div>
  `;
  
  document.getElementById('paymentHistory').innerHTML = html;
}

// Weekly status indicators
function getWeekStatusBadge(isPaid) {
  if (isPaid) {
    return '<span style="background: #48bb78; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.85em;">✓ Paid</span>';
  } else {
    return '<span style="background: #f56565; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.85em;">Unpaid</span>';
  }
}
        // ===== INITIALIZATION =====

        // ===== MAIN ENTRY POINT =====
        document.addEventListener('DOMContentLoaded', () => {
  if (CONFIG.scriptUrl && !/YOUR_ACTUAL_SCRIPT_ID_HERE/.test(CONFIG.scriptUrl)) {
    initializeApp();
  } else {
    alert('⚠️ App not configured!\n\nEdit index.html and set CONFIG.scriptUrl to your Google Script /exec URL.');
  }
});

    </script>
</body>
</html>





















